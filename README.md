# 网络优化  

## 一、网络优化的必要性  

### 流量
App的流量消耗对用户来说是比较敏感的, 虽然最近开始流量比较便宜，很多人开始使用无线网，但是大部分用户在室外没有wifi的时候还是比较关心流量的消耗。尤其是相对于网络不发达地区的用户，更需要减少不必要的网络消耗。  

### 用户体验  
关注网络异常情况进行优化可以让app有更好的用户体验。如果页面加载时间过长，会流失很多第一次使用app的用户。就我个人而言，如果一个页面加载时间太长，如果对某个内容比较感兴趣会等待一会，如果很久没有响应，那么就没有了进一步了解的兴趣。  

### 电量消耗
电量优化也是Android优化的重要内容之一，网络请求是消耗电量的，多余的网络请求无疑是消耗了额外的电量。  

## 二、如何进行网络优化  

### 减少网络的请求频次
注册登录。 正常会有两个API, 注册和登录, 但是设计API时我们应该给注册接口包含一个隐式的登录. 来避免App在注册后还得请求一次登录接口(有可能失败, 从而
导致业务流程失败)。对这个了解的不多，主要的工作应该还是在Server端。目前我们的app是两个接口分开的。  

### 减少网络的请求频次
使用Gzip来压缩request和response, 减少传输数据量, 从而减少流量消耗。Gzip在压缩的时候核心思想是：如果一个串中有两个重复的串，那么只需要知道第一个
串的内容和后面串相对于第一个串起始位置的距离 + 串的长度。  

举个栗子：
假如有 ABCDEFGABCDEFH → ABCDEFG(7,6)H。7 指的是往前第 7 个数开始，6 指的是重复串的长度，ABCDEFG(7,6)H 完全可以表示前面的串，并且是没有二义性的。  
Gzip工作流程如下图
![image](https://github.com/weihuihuang/MyAndroidStudyNotes/blob/master/pic/networkpics/gzip_pic.png)  
                                                （此图片来自网络）  
首先,客户端发请求给服务端,会带上请求头:Accept-Encoding:gzip。第二步，服务端接收到请求头后，可以选择压缩或不压缩。第三步，服务端选择压缩后，文件明
显变小，同时在响应头加上Content-Encoding:gzip。第四步，客户端接收到响应后，根据响应头中是否带有Content-Encoding:gzip，判断文件是否被压缩，如果压缩就进行解压，如果没有压缩，就按照正常方式读取数据即可。
![image](https://github.com/weihuihuang/MyAndroidStudyNotes/blob/master/pic/networkpics/fildder.png)  
这是用fiddler抓取的我们的一个接口的请求，可以看到header里面有Accept-Encoding: gzip，代表okhttp开启了Gzip压缩。okhttp默认开启gzip压缩。  

### 动态获取图片大小、质量
比如天猫，在网络较好或者wifi的情况下获取高质量图片，在网络较差的情况下(3G,4G）获取低质量图片。关于这个我们项目暂时无法实施。  

### 打包网络请求
比如学习记录一条一条上传肯定不如一次上传多条更节省流量，header里面的一些内容都是重复的，这部分资源就节省下来了。  

### 选择性提前加载数据
判断当前用户的网络条件，假如是WIFI的情况下，可以适当提前加载一些分页的数据等等，这样既不消耗用户数据流量，在加载下一部分数据时，因为提前加载，用户视觉上会显得更流畅，建议在用户使用频率较高的页面（如果有做行为采集，可以和相关人员确认，并统计这些页面）和数据量较大的接口做这个优化。  

### 实现网络缓存
这个是我觉得比较想做和有必要的功能之一，网络缓存可以在网络较差无响应或者页面加载失败的时候加载缓存数据，让用户在离线的情况下也可以使用部分app的功能。
HTTP本身提供了一套缓存相关的机制。这套机制定义了相关的字段和规则，用来客户端和服务端进行缓存相关的协商，如响应的数据是否需要缓存，缓存有效期，缓存是否有效，服务器端给出指示，而客户端则根据服务端的指示做具体的缓存更新和读取缓存工作。    

http缓存可以分为两类：
强制缓存:是直接向缓存数据库请求数据，如果找到了对应的缓存数据，并且是有效的，就直接返回缓存数据。如果没有找到或失效了，则向服务器请求数据，返回数据和缓存规则，同时将数据和缓存规则保存到缓存数据库中。
对比缓存：是先向缓存数据库获取缓存数据的标识，然后用该标识去服务器请求该标识对应的数据是否失效，如果没有失效，服务器会返回304未失效响应，则客户端使用该标识对应的缓存。如果失效了，服务器会返回最新的数据和缓存规则，客户端使用返回的最新数据，同时将数据和缓存规则保存到缓存数据库中。
这是我找的一个使用了retrofit2+okhttp3+rxjava作缓存的项目。可以参考下具体的实现。  
项目地址：https://github.com/yale8848/RetrofitCache

## 三、进行网络监测  

## 一些网络监测的可视化的工具  

### AndroidStudio自带的可视化工具 Network Monitor  

## 四、自己的设想和实现  

网络监测也是比较重要的功能之一，我自己的设想是做一个小的工具进行使用，现在做了一个比较粗糙的版本。迭代开发之后可以开启此功能对修改的页面进行监控，app在前台时网络请求消耗是否有异常，在后台时是否有不必要的网络请求在后台运行，再对相关的代码进行定位。  
项目地址：https://github.com/weihuihuang/TrafficMonitor





